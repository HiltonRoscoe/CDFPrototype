# Streaming Tabulator Prototype

> [!WARNING]
> This is intended to serve as a prototype to demonstrate how NIST CDF CVRs could be tabulated. It is not intended to be used in real elections as-is.

This prototype demonstrates the use of [XSLT 3.0 streaming](https://www.w3.org/TR/xslt-30/#streaming-concepts) to effectively handle large [NIST SP 1500-103](https://github.com/usnistgov/CastVoteRecords) instance files.

These large files are difficult to process using naive methods as most techniques assume that the entire file can be loaded into memory.

## Principle of operation

XSLT 3.0 introduces a number of new concepts to support streaming. The first of which is accumulators. Accumulators allow a result to be computed as the file is processed. Accumulators are used for two different purposes in the prototype. The first is to store information that is used later (such as information under `Election`, `Party`, `GpUnit`, etc.). The second is to accumulate votes as the file is processed.

Once all votes have been accumulated, the election is reported out using the [NIST 1500-100 Election Results Reporting v2.0 CDF](https://github.com/usnistgov/ElectionResultsReporting/tree/version2). This is aided by the fact that the ERR and CVR specifications are very similar.

## Running the prototype

This prototype uses [Saxon](https://www.saxonica.com/download/java.xml) specific extensions. Further, these extensions require a minimum of `Saxon-PE`. Streaming requires `Saxon-EE`. The prototype has been tested on Saxon 9.9 and 10.2 (Java), as well as OxygenXML 22.1.

The tabulator is located under `xsl/tabulator.xsl` of this directory.

```cmd
java -jar saxon-ee-10.2.jar -s:a:\cvr10.xml -xsl:tabulator.xsl -o:a:\out.xml
```

## Generating test decks

A very small CVR instance is provided under `xml/cvr10.xml`. A better approach is to generate your own CVRs, you can use `test_deck_generator.xsl` to do this. You must provide `xml/example_1.xml` as input.

```cmd
java -jar saxon9ee.jar -s:{path}\example_1.xml -xsl:test_deck_generator.xsl -o:a:\out.xml numToGenerate=15
```

You can control how many CVRs are generated by changing the `numToGenerate` parameter.

## Limitations

This prototype only supports `n-of-m` (sometimes referred to as plurality voting). Additionally, it does not apply any business rules (e.g. calculation of overvotes via allocability). The generated test desk CVRs have all allocation decisions pre-made.

## Other Notes

The CVR Prototype diverges from the published NIST CVR specification in one important way. The CVR schema has its elements ordered alphabetically (with some exceptions). This means that all `CVR`s appear before any of the reusable data. This precludes the effective use of streaming. We intend to fix this issue in a subsequent release.
